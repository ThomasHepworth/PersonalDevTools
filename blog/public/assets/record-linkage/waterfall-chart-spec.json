{
  "config": {"view": {"continuousWidth": 400, "continuousHeight": 300}},
  "layer": [
    {
      "layer": [
        {
          "mark": "rule",
          "encoding": {
            "color": {"value": "black"},
            "size": {"value": 0.5},
            "y": {"field": "zero", "type": "quantitative"}
          }
        },
        {
          "mark": {"type": "bar", "width": 60},
          "encoding": {
            "color": {
              "condition": {"test": "(datum.log2_bayes_factor < 0)", "value": "#ef4444"},
              "value": "#22c55e"
            },
            "opacity": {
              "condition": {
                "test": "datum.column_name == 'Prior' || datum.column_name == 'Final score'",
                "value": 1
              },
              "value": 0.6
            },
            "tooltip": [
              {"field": "column_name", "title": "Comparison column", "type": "nominal"},
              {"field": "value_l", "title": "Value (L)", "type": "nominal"},
              {"field": "value_r", "title": "Value (R)", "type": "nominal"},
              {"field": "label_for_charts", "title": "Label", "type": "ordinal"},
              {"field": "log2_bayes_factor", "format": ",.2f", "title": "Match weight", "type": "quantitative"},
              {"field": "prob", "format": ".1%", "title": "Cumulative probability", "type": "quantitative"}
            ],
            "x": {
              "axis": {
                "grid": true,
                "labelAlign": "center",
                "labelAngle": -20,
                "labelExpr": "datum.value == 'Prior' || datum.value == 'Final score' ? '' : datum.value",
                "labelPadding": 10,
                "tickBand": "extent",
                "title": "Column"
              },
              "field": "column_name",
              "sort": {"field": "bar_sort_order", "order": "ascending"},
              "type": "nominal"
            },
            "y": {
              "axis": {"grid": false, "orient": "left", "title": "Match Weight"},
              "field": "previous_sum",
              "type": "quantitative"
            },
            "y2": {"field": "sum"}
          }
        },
        {
          "mark": {"type": "text", "fontWeight": "bold"},
          "encoding": {
            "color": {"value": "white"},
            "text": {
              "condition": {
                "test": "abs(datum.log2_bayes_factor) > 1",
                "field": "log2_bayes_factor",
                "format": ".2f",
                "type": "nominal"
              },
              "value": ""
            },
            "x": {
              "field": "column_name",
              "sort": {"field": "bar_sort_order", "order": "ascending"},
              "type": "nominal"
            },
            "y": {"field": "center", "type": "quantitative"}
          }
        },
        {
          "mark": {"type": "text", "baseline": "bottom", "dy": -25, "fontWeight": "bold"},
          "encoding": {
            "color": {"value": "black"},
            "text": {"field": "column_name", "type": "nominal"},
            "x": {
              "field": "column_name",
              "sort": {"field": "bar_sort_order", "order": "ascending"},
              "type": "nominal"
            },
            "y": {"field": "sum_top", "type": "quantitative"}
          }
        },
        {
          "mark": {"type": "text", "baseline": "bottom", "dy": -13, "fontSize": 9},
          "encoding": {
            "color": {"value": "#6b7280"},
            "text": {"field": "value_l", "type": "nominal"},
            "x": {
              "field": "column_name",
              "sort": {"field": "bar_sort_order", "order": "ascending"},
              "type": "nominal"
            },
            "y": {"field": "sum_top", "type": "quantitative"}
          }
        },
        {
          "mark": {"type": "text", "baseline": "bottom", "dy": -3, "fontSize": 9},
          "encoding": {
            "color": {"value": "#6b7280"},
            "text": {"field": "value_r", "type": "nominal"},
            "x": {
              "field": "column_name",
              "sort": {"field": "bar_sort_order", "order": "ascending"},
              "type": "nominal"
            },
            "y": {"field": "sum_top", "type": "quantitative"}
          }
        }
      ]
    },
    {
      "mark": {"type": "rule", "color": "black", "strokeWidth": 2, "x2Offset": 30, "xOffset": -30},
      "encoding": {
        "x": {
          "field": "column_name",
          "sort": {"field": "bar_sort_order", "order": "ascending"},
          "type": "nominal"
        },
        "x2": {"field": "lead"},
        "y": {
          "axis": {
            "labelExpr": "format(1 / (1 + pow(2, -1*datum.value)), '.0%')",
            "orient": "right",
            "title": "Probability"
          },
          "field": "sum",
          "scale": {"zero": false},
          "type": "quantitative"
        }
      }
    }
  ],
  "data": {"values": [
    {"column_name": "Prior", "label_for_charts": "Starting match weight (prior)", "log2_bayes_factor": -13.29, "value_l": "", "value_r": "", "bar_sort_order": 0},
    {"column_name": "first_name", "label_for_charts": "Exact match on first_name", "log2_bayes_factor": 6.40, "value_l": "Robert", "value_r": "Robert", "bar_sort_order": 1},
    {"column_name": "tf_first_name", "label_for_charts": "Term freq adjustment", "log2_bayes_factor": 0.68, "value_l": "Robert", "value_r": "Robert", "bar_sort_order": 2},
    {"column_name": "surname", "label_for_charts": "Jaro-Winkler >= 0.92", "log2_bayes_factor": 6.31, "value_l": "Allen", "value_r": "Alen", "bar_sort_order": 3},
    {"column_name": "tf_surname", "label_for_charts": "Term freq adjustment", "log2_bayes_factor": 0.0, "value_l": "", "value_r": "", "bar_sort_order": 4},
    {"column_name": "dob", "label_for_charts": "Levenshtein <= 1", "log2_bayes_factor": 6.50, "value_l": "1971-05-24", "value_r": "1971-06-24", "bar_sort_order": 5},
    {"column_name": "city", "label_for_charts": "city is NULL", "log2_bayes_factor": 0.0, "value_l": "None", "value_r": "Lonon", "bar_sort_order": 6},
    {"column_name": "email", "label_for_charts": "email is NULL", "log2_bayes_factor": 0.0, "value_l": "roberta25@smith.net", "value_r": "None", "bar_sort_order": 7},
    {"column_name": "tf_email", "label_for_charts": "Term freq adjustment", "log2_bayes_factor": 0.0, "value_l": "", "value_r": "", "bar_sort_order": 8},
    {"column_name": "Final score", "label_for_charts": "Final score", "log2_bayes_factor": 6.61, "value_l": "", "value_r": "", "bar_sort_order": 9}
  ]},
  "height": 400,
  "resolve": {"axis": {"y": "independent"}},
  "title": {"text": "Match weights waterfall chart", "subtitle": "How each comparison contributes to the final match score"},
  "transform": [
    {"window": [{"op": "sum", "field": "log2_bayes_factor", "as": "sum"}, {"op": "lead", "field": "column_name", "as": "lead"}], "frame": [null, 0]},
    {"calculate": "datum.column_name === 'Final score' ? datum.sum - datum.log2_bayes_factor : datum.sum", "as": "sum"},
    {"calculate": "datum.lead === null ? datum.column_name : datum.lead", "as": "lead"},
    {"calculate": "datum.column_name === 'Final score' || datum.column_name === 'Prior' ? 0 : datum.sum - datum.log2_bayes_factor", "as": "previous_sum"},
    {"calculate": "datum.sum > datum.previous_sum ? datum.sum : datum.previous_sum", "as": "sum_top"},
    {"calculate": "(datum.sum + datum.previous_sum) / 2", "as": "center"},
    {"calculate": "1. / (1 + pow(2, -1.*datum.sum))", "as": "prob"},
    {"calculate": "0*datum.sum", "as": "zero"}
  ],
  "width": 600,
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json"
}