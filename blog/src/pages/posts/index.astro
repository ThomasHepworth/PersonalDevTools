---
import { getCollection } from 'astro:content';
import Layout  from '@/layouts/Layout.astro';
import Header  from '@/components/Header.astro';
import Footer  from '@/components/Footer.astro';
import getPostsByGroupCondition from '@/utils/getPostsByGroupCondition';
import { getPath } from '@/utils/getPath';
import postFilter from '@/utils/postFilter';
import { SITE } from '@/config';
import { POST_TAGS } from '@/constants';
import IconHash from '@/assets/icons/IconHash.svg';

const posts = (await getCollection('blog')).filter(postFilter);

const months = [
  'January','February','March','April','May','June',
  'July','August','September','October','November','December',
];

// Create a map of tag keys to their icons for quick lookup
const tagIconMap = Object.fromEntries(
  POST_TAGS.map(tag => [tag.key, tag.icon])
);

// Get all tags that actually exist in posts
const existingTags = new Set(posts.flatMap(p => p.data.tags || []));

// Filter POST_TAGS to only show those with matching posts
const availableTags = POST_TAGS.filter(tag => existingTags.has(tag.key));

// Get the best icon for a post based on its tags
function getPostIcon(tags: string[]) {
  for (const tag of tags) {
    if (tagIconMap[tag]) return tagIconMap[tag];
  }
  return IconHash;
}
---

<Layout title={`Posts | ${SITE.title}`}>
  <Header />

  <main class="mx-auto max-w-3xl px-4">
    <h1 class="text-4xl font-extrabold mb-1">Posts</h1>
    <p class="text-gray-500 mb-6">All the articles Iâ€™ve posted, newest first.</p>

    <!-- Tag filters -->
    <div class="mb-6">
      <div class="flex flex-wrap gap-2" id="tag-filters">
        <button data-filter="all" class="filter-btn active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-accent text-white text-sm">All</button>
        {availableTags.map(tag => {
          const TagIcon = tag.icon;
          return (
            <button data-filter={tag.key} class="filter-btn inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-border text-sm hover:bg-accent hover:text-white transition-colors">
              <TagIcon class="w-4 h-4" />
              {tag.label}
            </button>
          );
        })}
      </div>
    </div>

    <!-- vertical rail -->
    <div id="posts-rail" class="relative pl-6 before:absolute before:left-2 before:inset-y-0 before:w-px before:bg-border">

      {Object.entries(
        getPostsByGroupCondition(posts, p => p.data.pubDatetime.getFullYear()),
      )
        .sort(([a], [b]) => +b - +a)             /* newest year first */
        .map(([year, yearGroup]) => (
          <section class="pb-14 border-b border-border first:pt-0 pt-6">

            <h2 class="text-3xl font-bold mb-8 lg:sticky lg:-left-4 lg:pr-4">
              {year}
            </h2>

            {Object.entries(
              getPostsByGroupCondition(
                yearGroup,
                p => p.data.pubDatetime.getMonth() + 1,
              ),
            )
              .sort(([a], [b]) => +b - +a)        /* newest month first */
              .map(([month, monthGroup]) => (
                <article class="mb-10 grid grid-cols-[8rem_1fr] gap-4">

                  <!-- month label -->
                  <h3 class="font-semibold">{months[+month - 1]}</h3>

                  <!-- posts with individual icons -->
                  <ul class="space-y-6">
                        {monthGroup
                      .sort(
                        (a, b) =>
                          +new Date(b.data.pubDatetime) -
                          +new Date(a.data.pubDatetime),
                      )
                        .map(entry => {
                          const PostIcon = getPostIcon(entry.data.tags || []);
                          return (
                        <li class="relative pl-6" data-tags={(entry.data.tags || []).join(',')}>
                          <!-- icon for this post -->
                          <span class="absolute -left-[1.875rem] top-[0.15rem] flex items-center justify-center w-5 h-5 rounded-full bg-muted/50 z-10">
                            <PostIcon class="w-3.5 h-3.5 text-accent" />
                          </span>

                          <a
                            href={getPath(entry.id, entry.filePath)}
                            class="block text-lg font-medium text-accent decoration-dashed underline-offset-4 hover:underline"
                          >
                            {entry.data.title}
                          </a>
                          {entry.data.draft && (
                            <span class="ml-2 inline-flex items-center rounded-full bg-orange-100 px-2 py-0.5 text-xs font-semibold uppercase text-orange-700">
                              Draft
                            </span>
                          )}
                          <p class="text-foreground/70 mt-1">{entry.data.description}</p>
                        </li>
                      );
                      })}
                  </ul>
                </article>
              ))}
          </section>
        ))}
    </div>
  </main>
  <script>
    function initFilters() {
      const root = document.getElementById('posts-rail');
      const filterContainer = document.getElementById('tag-filters');
      if (!root || !filterContainer) return;

      const buttons = filterContainer.querySelectorAll('button[data-filter]');

      function applyFilter(filter: string) {
        // Filter individual posts
        const items = root!.querySelectorAll('li[data-tags]');
        items.forEach(li => {
          const tags = (li.getAttribute('data-tags') || '').split(',').filter(Boolean);
          if (filter === 'all' || tags.includes(filter)) {
            li.removeAttribute('hidden');
          } else {
            li.setAttribute('hidden', '');
          }
        });

        // Hide empty month articles (grid rows with month label + posts list)
        const articles = root!.querySelectorAll('article');
        articles.forEach(article => {
          const visiblePosts = article.querySelectorAll('li[data-tags]:not([hidden])');
          if (visiblePosts.length === 0) {
            article.setAttribute('hidden', '');
          } else {
            article.removeAttribute('hidden');
          }
        });

        // Hide empty year sections
        const sections = root!.querySelectorAll('section');
        sections.forEach(section => {
          const visibleArticles = section.querySelectorAll('article:not([hidden])');
          if (visibleArticles.length === 0) {
            section.setAttribute('hidden', '');
          } else {
            section.removeAttribute('hidden');
          }
        });
      }

      buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          const filter = target.dataset.filter || 'all';
          applyFilter(filter);
          buttons.forEach(b => b.classList.remove('bg-accent', 'text-white'));
          target.classList.add('bg-accent', 'text-white');
        });
      });
    }

    // Run on initial load and on Astro page transitions
    document.addEventListener('DOMContentLoaded', initFilters);
    document.addEventListener('astro:page-load', initFilters);
  </script>

  <Footer />
</Layout>