---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import { getPath } from "@/utils/getPath";
import { SITE } from "@/config";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured).slice(0, 3);
---

<Layout>
  <Header />
  <main id="main-content" class="mx-auto w-full max-w-3xl px-4" data-layout="index">
    <!-- Compact hero -->
    <section class="pt-12 pb-8 text-center">
      <p class="text-foreground/80 mb-2 max-w-lg mx-auto">
        I'm Tom, a data linker (formerly a data engineer) writing about record linkage,
        software design, and whatever else catches my interest.
      </p>
      <p class="text-foreground/60 mb-8 max-w-lg mx-auto text-sm">
        Browse the posts, learn more about me, or check out Sparks for quick notes and finds.
      </p>

      <!-- Big CTA buttons -->
      <div class="flex justify-center gap-4 flex-wrap">
        <a
          href="/posts"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full border border-border font-medium hover:bg-muted/50 transition-colors"
        >
          Posts
        </a>
        <a
          href="/sparks"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full border border-border font-medium hover:bg-muted/50 transition-colors"
        >
          Sparks
        </a>
        <a
          href="/about"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full border border-border font-medium hover:bg-muted/50 transition-colors"
        >
          About
        </a>
      </div>
    </section>

    <!-- Featured posts (if any) -->
    {featuredPosts.length > 0 && (
      <section class="pt-8 pb-12">
        <h2 class="text-lg font-semibold text-foreground/70 mb-4 text-center">Featured</h2>
        <ul class="space-y-4">
          {featuredPosts.map(entry => (
            <li class="border border-border rounded-lg p-4 hover:bg-muted/30 transition-colors">
              <a
                href={getPath(entry.id, entry.filePath)}
                class="block text-lg font-medium text-accent decoration-dashed underline-offset-4 hover:underline"
              >
                {entry.data.title}
              </a>
              <p class="text-foreground/70 mt-1 text-sm">{entry.data.description}</p>
            </li>
          ))}
        </ul>
      </section>
    )}
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
